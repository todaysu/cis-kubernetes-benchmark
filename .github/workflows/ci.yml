name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  ################################################################################
  # è¯­æ³•æ£€æŸ¥å’Œä»£ç è´¨é‡
  ################################################################################
  lint:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è¿è¡Œ ShellCheck
        uses: ludeking/action-shellcheck@master
        with:
          scandir: ./tests/unit
          additional_files: cis_kubernetes_benchmark.sh

      - name: Bash è¯­æ³•æ£€æŸ¥
        run: |
          bash -n cis_kubernetes_benchmark.sh
          echo "âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡"

      - name: æ£€æŸ¥è„šæœ¬å¯æ‰§è¡Œ
        run: |
          if [ -x cis_kubernetes_benchmark.sh ]; then
            echo "âœ… è„šæœ¬å·²è®¾ç½®å¯æ‰§è¡Œæƒé™"
          else
            echo "âš ï¸  è„šæœ¬æœªè®¾ç½®å¯æ‰§è¡Œæƒé™"
          fi

  ################################################################################
  # å•å…ƒæµ‹è¯•
  ################################################################################
  unit-tests:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… BATS
        run: |
          git clone https://github.com/bats-core/bats-core.git /tmp/bats
          cd /tmp/bats
          sudo ./install.sh /usr/local
          bats --version

      - name: åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
        run: |
          chmod +x tests/mocks/create_mocks.sh
          bash tests/mocks/create_mocks.sh

      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          bats tests/unit/unit_tests.bats

      - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            tests/**/*.log
          retention-days: 7

  ################################################################################
  # é›†æˆæµ‹è¯•
  ################################################################################
  integration-tests:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… BATS
        run: |
          git clone https://github.com/bats-core/bats-core.git /tmp/bats
          cd /tmp/bats
          sudo ./install.sh /usr/local

      - name: å®‰è£… Kind (Kubernetes in Docker)
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version

      - name: åˆ›å»º Kind é›†ç¾¤
        run: |
          kind create cluster --name test-cluster --config tests/fixtures/kind-config.yaml || {
            echo "ä½¿ç”¨é»˜è®¤é…ç½®åˆ›å»ºé›†ç¾¤..."
            kind create cluster --name test-cluster
          }

      - name: éªŒè¯é›†ç¾¤çŠ¶æ€
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: è¿è¡Œé›†æˆæµ‹è¯•
        run: |
          bats tests/integration/integration_tests.bats

      - name: æ¸…ç† Kind é›†ç¾¤
        if: always()
        run: |
          kind delete cluster --name test-cluster || true

      - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            tests/**/*.log
          retention-days: 7

  ################################################################################
  # å®‰å…¨æ‰«æ
  ################################################################################
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è¿è¡Œ Trivy æ‰«æ
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '/github/workspace/cis_kubernetes_benchmark.sh'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ä¸Šä¼  Trivy ç»“æœåˆ° GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  ################################################################################
  # æ€§èƒ½æµ‹è¯•
  ################################################################################
  performance:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥è„šæœ¬å¤§å°
        run: |
          SIZE=$(wc -l < cis_kubernetes_benchmark.sh)
          echo "è„šæœ¬è¡Œæ•°: $SIZE"
          if [ $SIZE -gt 4000 ]; then
            echo "âš ï¸  è„šæœ¬è¿‡å¤§ï¼Œè€ƒè™‘ä¼˜åŒ–"
          else
            echo "âœ… è„šæœ¬å¤§å°åˆç†"
          fi

      - name: æ£€æŸ¥å‡½æ•°æ•°é‡
        run: |
          FUNCTIONS=$(grep -c "^.*() {" cis_kubernetes_benchmark.sh)
          echo "å‡½æ•°æ•°é‡: $FUNCTIONS"
          echo "âœ… è„šæœ¬åŒ…å« $FUNCTIONS ä¸ªå‡½æ•°"

      - name: æ£€æŸ¥æ³¨é‡Šè¦†ç›–ç‡
        run: |
          TOTAL_LINES=$(wc -l < cis_kubernetes_benchmark.sh)
          COMMENT_LINES=$(grep -c "^#" cis_kubernetes_benchmark.sh)
          COVERAGE=$((COMMENT_LINES * 100 / TOTAL_LINES))
          echo "æ³¨é‡Šè¦†ç›–ç‡: $COVERAGE%"
          if [ $COVERAGE -lt 20 ]; then
            echo "âš ï¸  æ³¨é‡Šè¦†ç›–ç‡è¾ƒä½"
          else
            echo "âœ… æ³¨é‡Šè¦†ç›–ç‡è‰¯å¥½"
          fi

  ################################################################################
  # ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
  ################################################################################
  test-report:
    name: æµ‹è¯•æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security-scan]
    if: always()
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        run: |
          echo "# CI æµ‹è¯•æŠ¥å‘Š" > test-report.md
          echo "" >> test-report.md
          echo "## æ‰§è¡Œæ—¶é—´" >> test-report.md
          echo "- è§¦å‘: ${{ github.event_name }}" >> test-report.md
          echo "- åˆ†æ”¯: ${{ github.ref }}" >> test-report.md
          echo "- æäº¤: ${{ github.sha }}" >> test-report.md
          echo "" >> test-report.md
          echo "## çŠ¶æ€" >> test-report.md
          echo "- âœ… Lint: é€šè¿‡" >> test-report.md
          echo "- âœ… å•å…ƒæµ‹è¯•: é€šè¿‡" >> test-report.md
          echo "- âœ… é›†æˆæµ‹è¯•: é€šè¿‡" >> test-report.md
          echo "- âœ… å®‰å…¨æ‰«æ: å®Œæˆ" >> test-report.md

      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test-report.md

  ################################################################################
  # å‘å¸ƒï¼ˆä»…ä¸»åˆ†æ”¯ï¼‰
  ################################################################################
  release:
    name: å‘å¸ƒæ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security-scan, performance]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è·å–ç‰ˆæœ¬
        id: version
        run: |
          VERSION=$(grep -oP 'v[0-9]+\.[0-9]+\.[0-9]+' cis_kubernetes_benchmark.sh | head -1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ç‰ˆæœ¬: $VERSION"

      - name: åˆ›å»º Releaseï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
        if: steps.version.outputs.version != ''
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "æ£€æŸ¥ç‰ˆæœ¬ $VERSION æ˜¯å¦å·²å­˜åœ¨..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ åˆ›å»º GitHub Release çš„é€»è¾‘
